{% extends "base.html" %}
{% load staticfiles %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="row lower">
	<div class="col-md-12">
		<div class="page-header text-center">
			<span class="lead">{{ object.username }}</span>
			{% if is_owner %}
			<a href="{{ object.userprofile.edit_url }}">
                <button id="editSettings" type="button" class="btn btn-xs btn-success"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> edit</button>
            </a>
        	{% endif %}
			{% if is_other_user %}
                {% include 'includes/actions/follow.html' with user_pk=object.pk condition=already_follows %}
			{% endif %}
		</div>
	</div>
</div>

<img id="avatar" class="img-responsive img-thumbnail center-block"
	 src="{% if object.userprofile.picture %}{{ object.userprofile.picture.url }}{% else %}{% static 'img/placeholderavatar.png' %}{% endif %}"
	 alt="...">

<div class="row text-center">
	<br>
	<div class="col-md-12">
		<a href="{{ object.userprofile.watchlist_url }}" class="btn btn-sm btn-default">
			<span class="glyphicon glyphicon-list" aria-hidden="true"></span> watchlist
		</a>
		<a href="{{ object.userprofile.favourite_url }}" class="btn btn-sm btn-default">
			<span class="glyphicon glyphicon-heart-empty" aria-hidden="true"></span> favourites
		</a>
		<a href="{{ object.userprofile.recommend_url }}" class="btn btn-sm btn-default">
			<span class="glyphicon glyphicon-hand-right" aria-hidden="true"></span> recommend
		</a>
	</div>
</div>

{% if is_owner %}
<div class="row text-center">
	<br>
	<div class="col-md-12">
		{% if user.userprofile.imdb_id or user.userprofile.csv_ratings %}
		<div class="btn-group text-center">
			<form method="post" name="update_titles_form">{% csrf_token %}
				{% if user.userprofile.imdb_id %}
					<button class="btn btn-xs btn-primary" type="submit" name="update_rss" value="update_rss">update ratings</button>

					<button class="btn btn-xs btn-primary" type="submit" name="update_watchlist" value="update_watchlist">update watchlist</button>
				{% endif %}
				{% if user.userprofile.csv_ratings %}
					<button class="btn btn-xs btn-primary" type="submit" name="update_csv" value="update_csv">update csv</button>
				{% endif %}
			</form>
		</div>
		{% endif %}
	</div>
</div>
{% endif %}

<br>
<div class="row">
	<div class="col-md-8 col-md-offset-2">
		{% if not user_ratings.last_seen and is_owner %}
		<div class="text-center">
			<div class="alert alert-success alert-resize" role="alert">
				<p>You have no ratings yet.</p>
				<p><a href="{% url 'title-list' %}">Explore</a> titles or go ahead and <a href="{% url 'user-edit' user.username %}">edit</a> your profile to sync your account with IMDb.</p>
			</div>
		</div>
		{% endif %}
		<div class="panel panel-success">
			<div class="panel-heading text-center">Most Recently Rated</div>
			<div class="panel-body">
				{% if user_ratings.last_seen %}
				<div class="row">
					{% for entry in user_ratings.last_seen %}
						{% include 'movie/titles_in_a_row.html' with title=entry.title owner=is_owner rate=entry.rate req_user_rate=entry.req_user_curr_rating %}
					{% endfor %}
				</div>
				<hr>
				{% endif %}
				See all <a href="{{ object.userprofile.ratings_url }}">{{ object.userprofile.count_titles }} titles</a>
				or <a href="{{ object.userprofile.all_ratings_url }}">{{ object.userprofile.count_ratings }} ratings</a>
				<hr class="visible-sm visible-xs">
				<form id="import_form" method="post" enctype="multipart/form-data" action="{% url 'import-ratings' object.username %}" style="display:none">{% csrf_token %}
					<input id="import" name="csv_ratings" type="file" accept=".csv" />
				</form>

				<div style="display:inline;float: right;">
					{% if is_owner %}
						<form id="clear_ratings_form" method="post" action="{{ request.user.userprofile.get_absolute_url }}" style="display:inline;margin-right:10px">{% csrf_token %}
							<input id="confirm-nick" name="confirm-nick" hidden>
							<button id="clear_ratings" type="submit" class="btn btn-xs btn-success" data-toggle="tooltip" title="You cannot revert this operation. You will lose all of you ratings if you haven't exported them first.">clear my ratings</button>
						</form>
						<a id="import_ratings" href="{% url 'import-ratings' object.username %}" style="margin-right:10px" data-toggle="tooltip" title="You can add ratings from exported file."><button class="btn btn-xs btn-success">import</button></a>
					{% endif %}
					<a href="{% url 'export-ratings' object.username %}" data-toggle="tooltip" title="You can export all of your ratings as a form of backup. If you will lose some of your ratings, you will be able to import them." target="_blank"><button class="btn btn-xs btn-success">export</button></a>
				</div>
			</div>
		</div>
	</div>
</div>
{% if user_ratings.common_with_req_user %}
<div class="row">
	<div class="col-md-8 col-md-offset-2">
		<div class="panel panel-success">
			<div class="panel-heading text-center">Compared to you</div>
			<div class="panel-body">
				{% if user_ratings.common_with_req_user.not_rated_by_req_user %}
				<div>
					<div class="row">
						<p class="text-center lead">Titles {{ object.username }} liked that you haven't rated</p>
						{% for title in user_ratings.common_with_req_user.not_rated_by_req_user %}
							{% include 'includes/../../../movie/templates/movie/titles_in_a_row.html' with title=title owner=is_owner rate=title.user_rate %}
						{% endfor %}
					</div>
					See all <a href="{{ object.userprofile.ratings_exclude }}">{{ user_ratings.common_with_req_user.not_rated_by_req_user_count }} titles</a> you haven't rated
				</div>
				<hr>
				{% endif %}
				{% if user_ratings.common_with_req_user.higher %}
				<div class="row">
					<p class="text-center lead">Titles you rated higher</p>
					{% for title in user_ratings.common_with_req_user.higher %}
						{% include 'includes/../../../movie/templates/movie/titles_in_a_row.html' with title=title owner=is_owner rate=title.user_rate req_user_rate=title.req_user_rate %}
					{% endfor %}
				</div>
				<hr>
				{% endif %}
				{% if user_ratings.common_with_req_user.lower %}
				<div class="row">
					<p class="text-center lead">Titles you rated lower</p>
					{% for title in user_ratings.common_with_req_user.lower %}
						{% include 'includes/../../../movie/templates/movie/titles_in_a_row.html' with title=title owner=is_owner rate=title.user_rate req_user_rate=title.req_user_rate %}
					{% endfor %}
				</div>
				<hr>
				{% endif %}
				<p class="text-center lead">Summary</p>
				You and {{ object.username }} rated {{ user_ratings.common_with_req_user.count }} the same titles<br>
				{% if user_ratings.common_with_req_user.req_user_rate_avg %}
					You rated them {{ user_ratings.common_with_req_user.req_user_rate_avg|floatformat:2 }} and {{ object.username }} rated them {{ user_ratings.common_with_req_user.user_rate_avg|floatformat:2 }}<br>
				{% endif %}
				You saw {{ user_ratings.common_with_req_user.percentage }}% of {{ object.username }}'s
				<a href="{{ object.userprofile.ratings_url }}">{{ object.userprofile.count_titles }} ratings</a><br>
				<a href="{% url 'title-list' %}?u={{ object.username }}&exclude_his=on">See titles</a> that only you have seen
			</div>
		</div>
	</div>
</div>
{% endif %}
{% if user_ratings.last_seen %}
<div class="row">
	<div class="col-md-10 col-md-offset-1">
		<div class="text-center">
			<div id="graph_btns" class="btn-group" role="group" aria-label="...">
				<button id="graph_genres" class="btn btn-default">genres</button>
				<button id="graph_months" class="btn btn-default">months</button>
				<button id="graph_rated" class="btn btn-default">rated</button>
				<button id="graph_year" class="btn btn-default">year</button>
			</div>
		</div>
		<div id="graph" style="margin-top: 3%"></div>
	</div>
</div>
{% endif %}

<div id="dialog-confirm" title="Clear all your ratings?" style="display:none;">
	<p><span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>You cannot revert this operation. You will lose all of you ratings if you haven't exported them first. As a confirmation - enter your username and press OK.</p>
	<input type="text" id="confirm-nickname">
</div>
{% endblock %}