{% extends 'base.html' %}
{% load static %}
{% block breadcrumb %}
    <div class="ui breadcrumb">
        <a class="section" href="{% url 'home' %}">Home</a>
        <i class="right angle icon divider"></i>
        <a class="section" href="{% url 'user-list' %}">Users</a>
        <i class="right angle icon divider"></i>
        <a class="section" href="{% url 'user-detail' user.username %}">{{ user.username }}</a>
        <i class="right angle icon divider"></i>
        <a class="section active" href="{{ user.edit_url }}">Favourites</a>
    </div>
{% endblock %}
{#{% block title %}{{ title }}{% endblock %}#}
{% block content %}
    <div class="ui dividing header">
        <i class="list icon"></i>
        <div class="content">
            Favourites
            <div class="sub header">{% if is_owner %}You can reorder the list by dragging element while holding
                LMB.{% else %}See what {{ user.username }} likes{% endif %}</div>
        </div>
    </div>

    {% if title_list %}
        <h1 class="ui center aligned dividing header">{{ title_list|length }} titles</h1>
        <div id="sortable" class="ui items"{% if is_owner %} data-url="{% url 'user-fav-reorder' user.pk %}"{% endif %}>
            {% for title in title_list %}
                <div class="item-{{ title.pk }}">
                    <div class="ui tiny image">
                        <img src="{{ title.poster_small }}">
                    </div>
                    <div class="middle aligned content">
                        <span class="item-order">{{ forloop.counter }}</span>. <span class="order-change"></span>
                        <a class="header">{{ title }}</a>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="ui message">
            List is empty
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <script type="application/javascript">
        $sortable = $('#sortable');
        if ($sortable.length) {
            var url = $('#sortable').data('url');
            if (url) {
                sortable(url);
            }
        }

        function sortable(url) {
            $sortable.sortable({
                // $('tbody#sortable').sortable({
                placeholder: 'ui-state-highlight',
                axis: 'y',
                update: function (event, ui) {
                    var item = ui.item.find('.item-order');
                    var itemId = item.parent().parent().attr('id');
                    var ordering = $(this).sortable('serialize');
                    var o = $(this).sortable('toArray');

                    $(this).find('tr').each(function (i) {
                        var order = $(this).find('.item-order');
                        var orderChange = order.next();
                        orderChange.hide();
                        if (itemId == this.id) {
                            var newOrder = o.indexOf(itemId) + 1;
                            var previousOrder = parseInt(item.text());
                            var orderDiff = previousOrder - newOrder;
                            var txt = (orderDiff > 0 ? '+' : '') + orderDiff;
                            order.text(newOrder);
                            orderChange.text(txt);
                            orderChange.attr('class', 'order-change');
                            if (orderDiff > 0) {
                                orderChange.addClass('green-color');
                            } else {
                                orderChange.addClass('red-color');
                            }
                        } else {
                            order.text(i + 1);
                            orderChange.text('');
                            orderChange.attr('class', 'order-change');

                        }
                        orderChange.fadeIn('slow');
                    });
                    ajax_request({'item_order': ordering}, {url: url});
                }
            });
            $("#sortable").disableSelection();
        }
    </script>
{% endblock %}