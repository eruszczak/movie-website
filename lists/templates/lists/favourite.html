{% extends 'base.html' %}
{% load static %}
{% block breadcrumb %}
    <div class="ui breadcrumb">
        <a class="section" href="{% url 'home' %}">Home</a>
        <i class="right angle icon divider"></i>
        <a class="section" href="{% url 'user-list' %}">Users</a>
        <i class="right angle icon divider"></i>
        <a class="section" href="{% url 'user-detail' user.username %}">{{ user.username }}</a>
        <i class="right angle icon divider"></i>
        <a class="section active" href="{{ user.edit_url }}">Favourites</a>
    </div>
{% endblock %}
{#{% block title %}{{ title }}{% endblock %}#}
{% block content %}
    <div class="ui dividing header">
        <i class="list icon"></i>
        <div class="content">
            {{ user.username }}'s favourites
            <div class="sub header">{% if is_owner %}You can reorder the list by dragging element while holding
                LMB.{% else %}See what {{ user.username }} likes{% endif %}</div>
        </div>
    </div>

    {% if title_list %}
        <h1 class="ui center aligned dividing header">{{ title_list|length }} titles</h1>
        <div class="ui items"{% if is_owner %} id="sortable" data-url="{% url 'user-fav-reorder' %}"{% endif %}>
            {% for title in title_list %}
                <div id="{{ title.pk }}" class="item">
                    <div class="ui tiny image">
                        {% if title.user_rate and not is_owner %}
                            <span class="ui left corner label red green">
                                <span class="icon">{{ title.user_rate }}</span>
                            </span>
                        {% endif %}
                        <a href="{{ title.get_absolute_url }}"><img src="{{ title.poster_small }}"></a>
                    </div>
                    <div class="middle aligned content">
                        <div class="header">
                            <span class="item-order">{{ title.order }}</span>. <span class="ui circular label item-order-change hide"></span>
                            <a href="{{ title.get_absolute_url }}" class="header">{{ title }}</a>
                            {% include 'titles/includes/toggles.html' %}
                        </div>
                        <div class="description">
                            {% include 'titles/includes/rating.html' with rate=title.request_user_rate %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="ui message">
            List is empty
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <script type="application/javascript">
        $sortable = $('#sortable');
        if ($sortable.length) {
            sortable($sortable.data('url'));
        }

        function sortable(url) {
            $sortable.sortable({
                axis: 'y',
                start: function(e, ui) {
                    // creates a temporary attribute on the element with the old index
                    $(this).attr('data-previndex', ui.item.index());
                },
                update: function (event, ui) {
                    var newIndex = ui.item.index();
                    var oldIndex = $(this).attr('data-previndex');
                    var orderDiff = oldIndex - newIndex;
                    $(this).removeAttr('data-previndex');

                    // update item that was moved
                    var orderChange = ui.item.find('.item-order-change');
                    var orderBefore = ui.item.find('.item-order');
                    orderChange.removeClass('hide');
                    orderChange.text((orderDiff > 0 ? '+' : '') + orderDiff);
                    orderBefore.text(newIndex + 1);
                    if (orderDiff > 0) {
                        orderChange.removeClass('red').addClass('green');
                    } else {
                        orderChange.removeClass('green').addClass('red');
                    }

                    // update rest of the items
                    $(this).find('.item').each(function(i) {
                        if (i === newIndex) {
                            return;
                        }
                        orderBefore = $(this).find('.item-order');
                        orderChange = $(this).find('.item-order-change');
                        orderChange.addClass('hide');
                        orderBefore.text(i + 1);
                    });
                    ajax_request({'oldIndex': oldIndex, 'newIndex': newIndex}, {url: url});
                }
            });
        }
    </script>
{% endblock %}